services:
  mwebsite:
    image: mwebsite-image:latest
    build: .       # if youâ€™re rebuilding the nginx image
    volumes:
      - ./:/usr/share/nginx/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - python-backend
    ports:
      - "9005:80"
    restart: unless-stopped
    networks: 
      - mwebsitepr
      - proxy
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
      - traefik.enable=true

      # Tell Traefik how to reach mwebsitepr in the container
      - traefik.http.services.mwebsitepr.loadbalancer.server.port=80
      - traefik.http.services.mwebsitepr.loadbalancer.server.scheme=http
      
      - traefik.docker.network=proxy

      # Optional: redirect HTTP -> HTTPS on the host
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https

      # HTTP router (only for redirect)
      - traefik.http.routers.mwebsitepr-http.rule=${RULE}
      - traefik.http.routers.mwebsitepr-http.entrypoints=${HTTP_ENTRYPOINT}
      - traefik.http.routers.mwebsitepr-http.middlewares=redirect-to-https

      # HTTPS router (actual traffic)
      - traefik.http.routers.mwebsitepr-https.rule=${RULE}
      - traefik.http.routers.mwebsitepr-https.entrypoints=${HTTPS_ENTRYPOINT}
      - traefik.http.routers.mwebsitepr-https.tls=true
      - traefik.http.routers.mwebsitepr-https.tls.certresolver=${CERTRESOLVER}
      - traefik.http.routers.mwebsitepr-https.middlewares=${MIDDLEWARE}
    python-backend:
    image: mwebsite-backend:latest    # build this from mwebsitepr.com/python-backend
    build: ./python-backend
    volumes:
      - ./python-backend/scripts:/app/scripts:ro
    environment:
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - CONTACT_EMAIL_TO=${CONTACT_EMAIL_TO}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - CONTACT_EMAIL_FROM=${CONTACT_EMAIL_FROM}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_USE_TLS=${SMTP_USE_TLS}
      - CONTACT_EMAIL_SUBJECT_PREFIX=${CONTACT_EMAIL_SUBJECT_PREFIX}
    networks:
      - mwebsitepr
    restart: unless-stopped

networks:
  mwebsitepr:
  proxy:
    external: true
