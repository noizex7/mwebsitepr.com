<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/x-icon" href="/assets/MWebsiteLogo.png" />
  <link rel="stylesheet" href="/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="/style.css">
  <script src="/bootstrap/bootstrap.bundle.min.js"></script>
  <title>Python Demos | M Portfolio</title>
</head>

<body class="backgroundLight">
  <nav class="navbar navbar-expand-lg backgroundLight fixed-top">
    <div class="container-fluid navbar">
      <div class="brandAnchor">
        <a class="navbar-brand" href="/index.html">
          <img src="/assets/MWebsiteLogo.png" alt="" width="40" height="40" class="align-text-top my-1 brandImage">Portfolio
        </a>
      </div>
      <button class="navbar-toggler navbarToggle" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class=""><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
            class="bi bi-segmented-nav" viewBox="0 0 16 16">
            <path
              d="M0 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6zm6 3h4V5H6v4zm9-1V6a1 1 0 0 0-1-1h-3v4h3a1 1 0 0 0 1-1z" />
          </svg></span>
      </button>
      <div class="collapse navbar-collapse menu" id="navbarNav">
        <ul class="navbar-nav navbarCollapse">
          <li class="nav-item">
            <a class="nav-link" href="/index.html#greetings">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/index.html#work">Work</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/index.html#aboutMe">About Me</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/index.html#contact">Contact Me</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container pythonRunnerContainer">
    <div class="row">
      <div class="col-12">
        <h1 class="Header">Python Demos</h1>
        <p class="pythonDescription">Launch one of the showcase scripts on the server and interact with it in real time.
          Type into the console input whenever the program prompts you.</p>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="pythonControls">
          <div class="mb-3">
            <label class="form-label" for="script-selector">Choose a project</label>
            <select class="form-select" id="script-selector"></select>
          </div>
          <div class="pythonActionButtons">
            <button class="btn btn-dark" id="start-script" type="button">Start Script</button>
            <button class="btn btn-outline-dark" id="stop-script" type="button" disabled>Stop</button>
            <button class="btn btn-secondary" id="clear-output" type="button">Clear Output</button>
          </div>
          <p class="pythonStatus" id="python-status">Select a project and press Start Script.</p>
        </div>
        <h2 class="pythonOutputTitle">Program output</h2>
        <pre id="python-output" class="pythonOutput" aria-live="polite"></pre>
        <form class="pythonConsoleInput" id="console-form" autocomplete="off">
          <label class="form-label" for="console-input">Console input</label>
          <div class="pythonConsoleInputRow">
            <input class="form-control" id="console-input" type="text" placeholder="Type a line to send" autocomplete="off" disabled>
            <button class="btn btn-dark" id="send-input" type="submit" disabled>Send</button>
          </div>
          <small class="pythonConsoleHint">Input is sent line-by-line to the running script.</small>
        </form>
      </div>
    </div>
  </main>

  <footer class="backgroundDark pythonFooter">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <p class="pythonFooterText">Want to see the source? Reach out and Iâ€™ll share the repository links.</p>
        </div>
      </div>
    </div>
  </footer>

  <script type="module">
    const scriptSelector = document.getElementById("script-selector");
    const startButton = document.getElementById("start-script");
    const stopButton = document.getElementById("stop-script");
    const clearButton = document.getElementById("clear-output");
    const outputElement = document.getElementById("python-output");
    const statusElement = document.getElementById("python-status");
    const consoleForm = document.getElementById("console-form");
    const consoleInput = document.getElementById("console-input");
    const sendButton = document.getElementById("send-input");

    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsProtocol}://${window.location.host}/ws/run`;

    const params = new URLSearchParams(window.location.search);
    const scriptAliases = {
      password: "password_generator",
      pass: "password_generator",
      pwd: "password_generator",
      hangman: "hangman",
      rps: "rock_paper_scissors",
      "rock-paper-scissors": "rock_paper_scissors",
      "rock_paper_scissors": "rock_paper_scissors",
    };
    const requestedParam = params.get("example");
    const requestedScript = requestedParam ? (scriptAliases[requestedParam] || requestedParam) : null;

    let socketsScripts = [];
    let socket = null;
    let isRunning = false;

    function setStatus(message) {
      statusElement.textContent = message;
    }

    function appendOutput(text) {
      outputElement.textContent += text;
      outputElement.scrollTop = outputElement.scrollHeight;
    }

    function resetOutput() {
      outputElement.textContent = "";
    }

    function populateScripts(scripts) {
      socketsScripts = scripts;
      const existingSelection = scriptSelector.value;
      const requestedMatch = requestedScript && scripts.some((script) => script.id === requestedScript);
      const currentMatch = existingSelection && scripts.some((script) => script.id === existingSelection);
      const defaultSelection = requestedMatch
        ? requestedScript
        : currentMatch
          ? existingSelection
          : scripts.length > 0
            ? scripts[0].id
            : "";

      scriptSelector.innerHTML = "";
      scripts.forEach((script) => {
        const option = document.createElement("option");
        option.value = script.id;
        option.textContent = script.title;
        scriptSelector.append(option);
      });

      if (defaultSelection) {
        scriptSelector.value = defaultSelection;
      }
    }

    async function loadScripts() {
      try {
        const response = await fetch("/api/scripts");
        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}`);
        }
        const scripts = await response.json();
        populateScripts(scripts);
      } catch (error) {
        setStatus("Could not load script list automatically. Using defaults.");
        if (!socketsScripts.length) {
          const fallback = [
            { id: "password_generator", title: "Secure Password Generator" },
            { id: "hangman", title: "Hangman Game" },
            { id: "rock_paper_scissors", title: "Rock, Paper, Scissors" }
          ];
          populateScripts(fallback);
        }
      }
    }

    function enableConsole(enabled) {
      consoleInput.disabled = !enabled;
      sendButton.disabled = !enabled;
      if (!enabled) {
        consoleInput.value = "";
      } else {
        consoleInput.focus();
      }
    }

    function setRunning(running) {
      isRunning = running;
      startButton.disabled = running;
      stopButton.disabled = !running;
      enableConsole(running);
    }

    function closeSocket() {
      if (socket) {
        socket.close();
        socket = null;
      }
    }

    function handleSocketMessage(event) {
      let payload;
      try {
        payload = JSON.parse(event.data);
      } catch {
        return;
      }

      switch (payload.type) {
        case "scripts":
          if (!socketsScripts.length) {
            populateScripts(payload.scripts);
          }
          break;
        case "output":
          appendOutput(payload.data);
          break;
        case "status":
          handleStatus(payload);
          break;
        default:
          break;
      }
    }

    function handleStatus(statusPayload) {
      const { status, message, returncode } = statusPayload;
      if (status === "started") {
        setStatus("Script is running. Use the input box below to interact.");
        setRunning(true);
      } else if (status === "finished") {
        setStatus(`Script finished with exit code ${returncode}.`);
        setRunning(false);
        closeSocket();
      } else if (status === "error") {
        setStatus(message || "An error occurred.");
        setRunning(false);
      } else if (status === "stopped") {
        setStatus("Script stopped.");
        setRunning(false);
        closeSocket();
      }
    }

    function startScript() {
      const selected = scriptSelector.value;
      if (!selected) {
        setStatus("Please pick a script to run.");
        return;
      }

      resetOutput();
      setStatus("Connecting to backend...");

      closeSocket();

      socket = new WebSocket(wsUrl);

      socket.addEventListener("open", () => {
        setStatus("Connection established. Starting script...");
        socket.send(JSON.stringify({ action: "start", script: selected }));
      });

      socket.addEventListener("message", handleSocketMessage);

      socket.addEventListener("error", () => {
        setStatus("WebSocket error. Please try again.");
        setRunning(false);
      });

      socket.addEventListener("close", () => {
        if (isRunning) {
          setStatus("Connection closed unexpectedly.");
        }
        setRunning(false);
      });
    }

    function stopScript() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ action: "stop" }));
      }
    }

    function sendInput(event) {
      event.preventDefault();
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        return;
      }
      const value = consoleInput.value;
      if (!value) {
        return;
      }
      socket.send(JSON.stringify({ action: "input", data: `${value}\n` }));
      consoleInput.value = "";
    }

    startButton.addEventListener("click", startScript);
    stopButton.addEventListener("click", stopScript);
    clearButton.addEventListener("click", resetOutput);
    consoleForm.addEventListener("submit", sendInput);

    loadScripts();
  </script>
</body>

</html>
